# CLI (`@trinacria/cli`)

La CLI espone il comando `trinacria` con tre comandi principali:

- `dev`: avvio in sviluppo con autorestart
- `build`: compilazione TypeScript
- `start`: avvio produzione da output compilato

## Installazione

```bash
npm i -D @trinacria/cli
```

## Usage

```bash
trinacria dev
trinacria build
trinacria start
```

Opzioni comuni:

- `--config <path>` usa un file config custom
- `--help` mostra help

## Configurazione

Tipi supportati:

- `trinacria.config.js`
- `trinacria.config.cjs`
- `trinacria.config.mjs`

Se non trovi config, vengono applicati i default.

### Contratto config

```ts
export interface ResolvedConfig {
  entry: string;
  outDir: string;
  watchDir: string;
  env: "development" | "production" | string;
}
```

`TrinacriaConfig` è `Partial<ResolvedConfig>`.

### Default

```ts
{
  entry: "src/main.ts",
  outDir: "dist",
  watchDir: "src",
  env: "development"
}
```

### Esempio `trinacria.config.mjs`

```js
/** @type {import('@trinacria/cli').TrinacriaConfig} */
export default {
  entry: "src/main.ts",
  outDir: "dist",
  watchDir: "src",
  env: "development",
};
```

## Comando `dev`

```bash
trinacria dev
```

Comportamento:

- esegue `entry` tramite entry locale `tsx/cli`
- osserva `watchDir` con `chokidar`
- su modifica file: restart del processo
- debounce restart: `100ms`
- se l'app crasha (exit code != 0): restart automatico
- shutdown pulito su `SIGINT`/`SIGTERM`
- timeout stop child prima di `SIGKILL`: `3000ms`

## Comando `build`

```bash
trinacria build
```

Comportamento:

- cerca `tsconfig.json` nella cwd
- fallisce subito se `tsconfig.json` non è leggibile/parsale
- crea programma TypeScript con override `outDir` da config
- compila e mostra diagnostiche (error/warning con file:line:col)
- stampa numero file compilati e durata build
- exit code `1` se `emitSkipped` o errori

## Comando `start`

```bash
trinacria start
```

Comportamento:

- risolve il file JS da `entry` usando mapping TypeScript `rootDir/outDir`
- supporta mapping estensioni (`.ts/.tsx -> .js`, `.mts -> .mjs`, `.cts -> .cjs`)
- esegue con runtime Node corrente (`process.execPath`)
- eredita stdio
- fallisce se il file compilato non esiste
- fallisce se il processo figlio termina con codice != 0

## Flusso consigliato

Sviluppo:

```bash
trinacria dev
```

Build produzione:

```bash
trinacria build
trinacria start
```

## Risoluzione config (`--config`)

Ordine:

1. Se passi `--config`, usa quel path.
2. Altrimenti cerca i file default nella cwd.
3. Se non trova nulla, usa `defaultConfig`.

La CLI tenta prima `require()` (CJS), poi fallback a `import()` se il file è ESM.

Se `--config` è passato esplicitamente con path mancante/non valido, la CLI fallisce subito con errore.
